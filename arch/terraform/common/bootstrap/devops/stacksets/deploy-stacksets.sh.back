# #!/bin/bash
# OU_IDS='["ou-nz58-bru65ypz","ou-nz58-goywgvwb"]'
# STACKSET_NAME="ct-devops-p-tf-iam"
# APPLY_ROLE_NAME="ct-devops-p-tf-apply-iam_r"
# PLAN_ROLE_NAME="ct-devops-p-tf-plan-iam_r"

# REGION="ap-northeast-2"
# TEMPLATE_FILE="bootstrap.yaml"

# APPLY_TRUST_ARNS="\"arn:aws:iam::522114752812:role/aws-reserved/sso.amazonaws.com/ap-northeast-2/AWSReservedSSO_AWSAdministratorAccess_c184f8d61af8bb1a,arn:aws:iam::522114752812:role/devops-p-tf-ec2-iam_r"\"
# PLAN_TRUST_ARNS="\"arn:aws:iam::522114752812:role/aws-reserved/sso.amazonaws.com/ap-northeast-2/AWSReservedSSO_AWSAdministratorAccess_c184f8d61af8bb1a,arn:aws:iam::522114752812:role/devops-p-tf-ec2-iam_r"\"

# echo "[INFO] APPLY_TRUST_ARNS = ${APPLY_TRUST_ARNS}"
# echo "[INFO] PLAN_TRUST_ARNS  = ${PLAN_TRUST_ARNS}"

# # StackSet ì¡´ì¬ ì—¬ë¶€ í™•ì¸
# echo "[1/2] StackSet ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸ ì¤‘..."
# if aws cloudformation describe-stack-set \
#     --stack-set-name "$STACKSET_NAME" \
#     --region "$REGION" \
#     --call-as DELEGATED_ADMIN &>/dev/null; then

#   echo "âœ… StackSetì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ì—…ë°ì´íŠ¸ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤."
#   aws cloudformation update-stack-set \
#     --stack-set-name "$STACKSET_NAME" \
#     --template-body file://$TEMPLATE_FILE \
#     --parameters \
#       ParameterKey=ApplyRoleName,ParameterValue=$APPLY_ROLE_NAME \
#       ParameterKey=PlanRoleName,ParameterValue=$PLAN_ROLE_NAME \
#       ParameterKey=ApplyTrustArns,ParameterValue="$APPLY_TRUST_ARNS" \
#       ParameterKey=PlanTrustArns,ParameterValue="$PLAN_TRUST_ARNS" \
#     --capabilities CAPABILITY_NAMED_IAM \
#     --permission-model SERVICE_MANAGED \
#     --region "$REGION" \
#     --call-as DELEGATED_ADMIN \
#     --tags Key=map-migrated,Value=migPV0803AMRO
# else
#   echo "ğŸ†• StackSetì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒì„±í•©ë‹ˆë‹¤."
#   aws cloudformation create-stack-set \
#     --stack-set-name "$STACKSET_NAME" \
#     --template-body file://$TEMPLATE_FILE \
#     --parameters \
#       ParameterKey=ApplyRoleName,ParameterValue=$APPLY_ROLE_NAME \
#       ParameterKey=PlanRoleName,ParameterValue=$PLAN_ROLE_NAME \
#       ParameterKey=ApplyTrustArns,ParameterValue="$APPLY_TRUST_ARNS" \
#       ParameterKey=PlanTrustArns,ParameterValue="$PLAN_TRUST_ARNS" \
#     --capabilities CAPABILITY_NAMED_IAM \
#     --auto-deployment Enabled=true,RetainStacksOnAccountRemoval=false \
#     --permission-model SERVICE_MANAGED \
#     --region "$REGION" \
#     --call-as DELEGATED_ADMIN \
#     --tags Key=map-migrated,Value=migPV0803AMRO
#   echo "[2/2] Stack Instances ë°°í¬ ì¤‘..."
#   aws cloudformation create-stack-instances \
#     --stack-set-name "$STACKSET_NAME" \
#     --deployment-targets "OrganizationalUnitIds=${OU_IDS}" \
#     --regions "$REGION" \
#     --operation-preferences '{"FailureToleranceCount":5,"MaxConcurrentCount":10}' \
#     --region "$REGION" \
#     --call-as DELEGATED_ADMIN
# fi


# echo "âœ… StackSet ì²˜ë¦¬ ì™„ë£Œ"

